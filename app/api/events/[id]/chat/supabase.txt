import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase';
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY as string);
const model = genAI.getGenerativeModel({ model: "gemini-pro" });

async function streamToString(stream: ReadableStream<Uint8Array>): Promise<string> {
  const reader = stream.getReader();
  const decoder = new TextDecoder();
  let result = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) {
      break;
    }
    result += decoder.decode(value, { stream: true });
  }
  return result;
}

export async function POST(req: NextRequest, { params }: { params: { id: string } }) {
  try {
    const eventId = params.id;
    const body = await req.json();
    const { message } = body;

    if (!message) {
      return NextResponse.json({ error: 'Message is required' }, { status: 400 });
    }

    const { data: files, error: listError } = await supabase.storage
      .from('event-files')
      .list(eventId);

    if (listError) {
      console.error('Supabase list error:', listError);
      return NextResponse.json({ error: 'Failed to list files from Supabase' }, { status: 500 });
    }

    if (!files || files.length === 0) {
      return NextResponse.json({ response: "I couldn't find any documents for this event. Please upload some files first." });
    }

    let context = '';
    for (const file of files) {
      const { data: blob, error: downloadError } = await supabase.storage
        .from('event-files')
        .download(`${eventId}/${file.name}`);

      if (downloadError) {
        console.error(`Failed to download ${file.name}:`, downloadError);
        continue;
      }

      if (blob) {
        const fileContent = await streamToString(blob.stream());
        context += `\n\n--- Content from ${file.name} ---\n${fileContent}`;
      }
    }

    if (!context) {
        return NextResponse.json({ error: 'Could not read content from any of the event files.' }, { status: 500 });
    }

    // 3. Construct the prompt for Gemini
    const prompt = `You are a helpful assistant for an event. Your name is Backstage Brain.
    Based *only* on the context provided below, answer the user's question.
    Do not answer any questions that are not related to the content of the provided files. If the question is unrelated, simply say: "I can only answer questions related to this event."

    Context:
    ${context}

    User's Question:
    ${message}
    `;

    // 4. Call Gemini API
    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();

    return NextResponse.json({ response: text });
  } catch (error) {
    console.error('Chat API error:', error);
    return NextResponse.json({ error: 'An error occurred while processing your request.' }, { status: 500 });
  }
}

